-- Extend meterreadings table to include rich telemetry fields used by UI
-- Safe to run multiple times due to IF NOT EXISTS

ALTER TABLE IF EXISTS meterreadings
  -- Ensure base fields exist for compatibility with older tables
  ADD COLUMN IF NOT EXISTS status VARCHAR(20),
  ADD COLUMN IF NOT EXISTS unit_of_measurement VARCHAR(20),
  ADD COLUMN IF NOT EXISTS ip VARCHAR(50),
  ADD COLUMN IF NOT EXISTS device_ip VARCHAR(50),
  ADD COLUMN IF NOT EXISTS port INTEGER,
  ADD COLUMN IF NOT EXISTS slave_id INTEGER,
  ADD COLUMN IF NOT EXISTS source VARCHAR(50),
  -- raw arrays from modbus
  ADD COLUMN IF NOT EXISTS raw_basic DOUBLE PRECISION[],
  ADD COLUMN IF NOT EXISTS raw_extended DOUBLE PRECISION[],
  ADD COLUMN IF NOT EXISTS energy DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS power DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS frequency DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS power_factor DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_a_voltage DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_b_voltage DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_c_voltage DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_a_current DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_b_current DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_c_current DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_a_power DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_b_power DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_c_power DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS line_to_line_voltage_ab DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS line_to_line_voltage_bc DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS line_to_line_voltage_ca DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS total_active_power DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS total_reactive_power DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS total_apparent_power DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS total_active_energy_wh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS total_reactive_energy_varh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS total_apparent_energy_vah DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS import_active_energy_wh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS export_active_energy_wh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS import_reactive_energy_varh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS export_reactive_energy_varh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS frequency_hz DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS temperature_c DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS humidity DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS neutral_current DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS ground_current DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_a_power_factor DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_b_power_factor DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_c_power_factor DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_thd DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_thd DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_thd_phase_a DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_thd_phase_b DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_thd_phase_c DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_thd_phase_a DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_thd_phase_b DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_thd_phase_c DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_harmonic_3 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_harmonic_5 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_harmonic_7 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_harmonic_3 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_harmonic_5 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_harmonic_7 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS max_demand_kw DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS max_demand_kvar DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS max_demand_kva DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_demand_kw DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_demand_kvar DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_demand_kva DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS predicted_demand_kw DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_unbalance DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS current_unbalance DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_flicker DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS frequency_deviation DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS phase_sequence VARCHAR(10),
  ADD COLUMN IF NOT EXISTS phase_rotation VARCHAR(10),
  ADD COLUMN IF NOT EXISTS power_direction VARCHAR(10),
  ADD COLUMN IF NOT EXISTS reactive_direction VARCHAR(12),
  ADD COLUMN IF NOT EXISTS communication_status VARCHAR(20),
  ADD COLUMN IF NOT EXISTS last_communication TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS device_model VARCHAR(100),
  ADD COLUMN IF NOT EXISTS firmware_version VARCHAR(100),
  ADD COLUMN IF NOT EXISTS serial_number VARCHAR(100),
  ADD COLUMN IF NOT EXISTS manufacturer_code INTEGER,
  ADD COLUMN IF NOT EXISTS alarm_status VARCHAR(20),
  ADD COLUMN IF NOT EXISTS device_time TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS sync_status VARCHAR(20),
  ADD COLUMN IF NOT EXISTS time_source VARCHAR(20),
  ADD COLUMN IF NOT EXISTS event_counter INTEGER,
  ADD COLUMN IF NOT EXISTS last_event TEXT,
  -- UI shorthand fields
  ADD COLUMN IF NOT EXISTS kvah DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS kvarh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS v DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS a DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS kw DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS kwpeak DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS dpf DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS dpfchannel INTEGER,
  ADD COLUMN IF NOT EXISTS kwh DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS data_quality VARCHAR(20),
  -- Meter configuration
  ADD COLUMN IF NOT EXISTS current_transformer_ratio DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS voltage_transformer_ratio DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS pulse_constant DOUBLE PRECISION,
  -- Specific modbus registers
  ADD COLUMN IF NOT EXISTS modbus_register_40001 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS modbus_register_40002 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS modbus_register_40003 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS modbus_register_40004 DOUBLE PRECISION,
  ADD COLUMN IF NOT EXISTS modbus_register_40005 DOUBLE PRECISION;
